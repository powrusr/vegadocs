---
sidebar_position: 3
title: Running a secure data-node
sidebar_label: Data node security
hide_title: false
---

Before reading this document We recommend to reading the [security.md](Secure Validator) page. You may find there useful information.

As the node operator, you must provide the TLS to the APIs exposed to the internet to provide secure communication between people and your server. Another thing is that the GraphQL subscriptions won't work without TLS. To setup a secure server, you have a few options:

- The data node has an internal mechanism to provide the TLS and auto-request for the certificate.
- A proxy service like `nginx` or `caddy` if you wish to pass requests with some DMZ.

Before We start, let's discuss the APIs exposed with the data node. The data node exposes 3 APIs with two separate ports:

- GRPC port - default value is `3007` - the GRPC API
- Gateway port - default value is `3008` - the GraphQL and the REST APIs.

You should expose both GRPC and Gateway with a TLS. However, the data node's internal mechanism allows you to expose with TLS only the gateway port.

## List of secure data-nodes

The Vega validators run publicly available data nodes. We provide a list of publicly available data nodes in our [GitHub repository](https://github.com/vegaprotocol/networks/blob/master/mainnet1/mainnet1.toml). All of the listed (not commented) data nodes have TLS support.

## Run your secure data node

### A bit about TLS

The below examples show the autogenerated certificate from "Lets Encrypt", but you can also buy a certificate or use the certificate you already own. Just provide paths to the certificate and key in your configuration.

If you decide to use the certbot to obtain the certficate please read the below documentations:

- [Install certbot](https://www.inmotionhosting.com/support/website/ssl/lets-encrypt-ssl-ubuntu-with-certbot/)
- [Best practices for setting a cron job for Let's Encrypt (Certbot) renewal](https://serverfault.com/questions/790772/best-practices-for-setting-a-cron-job-for-lets-encrypt-certbot-renewal)

### Use internal data node's mechanism to expose Gateway (GraphQL and REST APIs) with TLS

Assumptions:

- You have got configured and running or ready to start data node service.
- You have the spare domain pointing to your server.
- You have free 443 port on your server where the data node is running.


### Use the Nginx as proxy service

Assumptions

- You have got `nginx` >= `1.13` to use the `grpc_proxy` feature.
- You have got `certbot` with the nginx extension
- Your data node is running and exposing `GRPC` API on port `3007` and `Gateway` on port `3008`
- You have the spare domain pointing to your server.

References:

- [`Nginx` documentation](https://nginx.org/en/docs/)

#### Example config

If you are going to use the certbot, you have to prepare the following configuration for the `Nginx`:

```nginx
server {
    server_name <grpc-domain>; # e.g server_name gprc.vega.mainnet.community;

    location / {
        grpc_pass grpc://127.0.0.1:3007; # it must point to your GRPC port on the  data-node

    }
    
    listen 80 http2;
}

server {
    server_name <gateway-domain>; # e.g server_name vega.mainnet.community;

    location / {
        proxy_pass http://127.0.0.1:3008; # This must point to your Gateway port on the data-node

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_set_header Host $host;
    }

    listen 80;
}
```

Then you have to generate certificates for your domains. To do it, just execute the `certbot` command. Once certificates have been generated, you have to update the `listen 443 ...` line on your GRPC server to the following line `listen 442 http2;`. 

So final config may looks like below:

```nginx
server {
    server_name grpc.vega.mainnet.community;

    location / {
        grpc_pass grpc://127.0.0.1:3007;

    }

    listen 443 http2; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/grpc.vega.mainnet.community/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/grpc.vega.mainnet.community/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
}

server {
    server_name vega.mainnet.community;

    location / {
        proxy_pass http://127.0.0.1:3008;

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_set_header Host $host;
    }

    listen 443 ssl; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/grpc.vega.mainnet.community/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/grpc.vega.mainnet.community/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
}

server {
    if ($host = vega.mainnet.community) {
        return 301 https://$host$request_uri;
    } # managed by Certbot


    server_name vega.mainnet.community;

    listen 80;
    return 404; # managed by Certbot
}

server {
    if ($host = grpc.vega.mainnet.community) {
        return 301 https://$host$request_uri;
    } # managed by Certbot

    server_name grpc.vega.mainnet.community;

    listen 80;
    return 404; # managed by Certbot
}
```

### Use the caddy as a proxy service

Assumptions:

- Caddy 1.17+ installed
- Your data node is running and exposing `GRPC` API on port `3007` and `Gateway` on port `3008`
- You have the spare domain pointing to your server.

References:

- [`Caddy` documentation](https://caddyserver.com/docs/)

#### Example config

```caddyfile
{
        email <admin-email-for-tls-purposes>
}


<gateway-domain>:443 {
        # REST & GQL
        route / {
                reverse_proxy http://127.0.0.1:3008
        }
        route /* {
                reverse_proxy http://127.0.0.1:3008
        }
}

<grpc-domain>:443 {
        reverse_proxy {
                to h2c://127.0.0.1:3007
                transport http {
                        versions h2c 2
                }
        }
}
```

Final config may be following:

```caddyfile
{
        email admin@vega.mainnet.community
}


vega.mainnet.community:443 {
        # REST & GQL
        route / {
                reverse_proxy http://127.0.0.1:3008
        }
        route /* {
                reverse_proxy http://127.0.0.1:3008
        }
}

grpc.vega.mainnet.community:443 {
        reverse_proxy {
                to h2c://127.0.0.1:3007
                transport http {
                        versions h2c 2
                }
        }

}
```